#include <Wire.h>
#include <LiquidCrystal_I2C.h>
#include <SPI.h>
#include <MFRC522.h>
#include <EEPROM.h>

/* ================= PIN ================= */
#define SS_PIN     D2
#define RST_PIN    D1
#define BUZZER_PIN D8

MFRC522 mfrc522(SS_PIN, RST_PIN);
LiquidCrystal_I2C lcd(0x27, 16, 2);

/* ============== DATA SISWA ============== */
struct DataSiswa {
  String nama;
  String kelas;
  String nis;
  bool isActive;
  unsigned long lastAttendance;
};

DataSiswa daftarSiswa[50];
int totalSiswa = 0;
int siswaAktifIndex = -1;

/* ============ KARTU MASTER ============ */
String masterCardUID = ""; // Akan diisi dari EEPROM/Web/Manual
bool masterCardTerdaftar = false;
String lastScannedUID = "";

/* ============ KARTU MASTER MANUAL (HARDCODED) ============ */
// UNCOMMENT dan isi dengan UID kartu master Anda jika ingin manual
// Contoh: "12 AB 34 CD" (tanpa spasi juga bisa)
// #define MASTER_CARD_MANUAL "12AB34CD"

/* ============ LOG ABSENSI ============ */
struct LogAbsensi {
  String uid;
  String nama;
  String kelas;
  String status;
  String waktu;
};
LogAbsensi logAbsensi[100];
int totalLog = 0;

/* ============ MODE SISTEM ============ */
enum ModeSistem {
  MODE_NORMAL,
  MODE_REGISTER,
  MODE_SET_MASTER,
  MODE_SELECT_SISWA
};
ModeSistem modeSaatIni = MODE_NORMAL;

/* ============ DEBOUNCING ============ */
unsigned long lastReadTime = 0;
const unsigned long READ_DELAY = 2000;

/* ============ EEPROM ============ */
#define EEPROM_SIZE 1024
#define EEPROM_MASTER_ADDR 0
#define EEPROM_DATA_ADDR 100

/* ======================================= */
void setup() {
  Serial.begin(115200);
  Serial.println("\n\n=== SISTEM ABSENSI 1 KARTU UNTUK SEMUA ===");
  
  pinMode(BUZZER_PIN, OUTPUT);
  
  Wire.begin(0, 2);
  lcd.init();
  lcd.backlight();
  
  lcd.clear();
  lcd.setCursor(0,0);
  lcd.print("ABSENSI 1 KARTU");
  lcd.setCursor(0,1);
  lcd.print("UNTUK SEMUA SISWA");
  delay(2000);
  
  SPI.begin();
  mfrc522.PCD_Init();
  
  byte version = mfrc522.PCD_ReadRegister(MFRC522::VersionReg);
  Serial.print("RFID Version: 0x");
  Serial.println(version, HEX);
  
  loadDataFromEEPROM();
  
  // CEK APAKAH ADA MASTER CARD MANUAL YANG DI-SET
  #ifdef MASTER_CARD_MANUAL
    masterCardUID = String(MASTER_CARD_MANUAL);
    masterCardTerdaftar = true;
    Serial.print("Menggunakan Master Card Manual: ");
    Serial.println(masterCardUID);
    
    lcd.clear();
    lcd.setCursor(0,0);
    lcd.print("MASTER MANUAL:");
    lcd.setCursor(0,1);
    lcd.print(masterCardUID.substring(0, 16));
    delay(2000);
    
    saveMasterCardToEEPROM();
  #endif
  
  updateLCD();
  Serial.println("Sistem siap!");
  Serial.println("Format ke Web: WEB,UID,NAMA,KELAS,STATUS");
  Serial.println("Ketik 'HELP' untuk menu serial");
  
  beep(1);
}

/* ======================================= */
void loop() {
  if (Serial.available()) {
    handleSerialCommand();
  }
  
  if (mfrc522.PICC_IsNewCardPresent() && mfrc522.PICC_ReadCardSerial()) {
    prosesKartuRFID();
  }
  
  static unsigned long lastLCDUpdate = 0;
  if (millis() - lastLCDUpdate > 1000) {
    updateLCD();
    lastLCDUpdate = millis();
  }
}

/* ============= PROSES KARTU RFID ============== */
void prosesKartuRFID() {
  unsigned long currentTime = millis();
  if (currentTime - lastReadTime < READ_DELAY) {
    mfrc522.PICC_HaltA();
    return;
  }
  lastReadTime = currentTime;
  
  String uid = bacaUID();
  lastScannedUID = uid;
  
  Serial.print("[RFID] UID: ");
  Serial.println(uid);
  
  // NORMALIZE UID (hapus spasi untuk komparasi)
  String uidNormalized = uid;
  uidNormalized.replace(" ", "");
  
  switch (modeSaatIni) {
    case MODE_NORMAL:
      prosesModeNormal(uidNormalized);
      break;
    case MODE_REGISTER:
      prosesModeRegister(uid);
      break;
    case MODE_SET_MASTER:
      prosesModeSetMaster(uidNormalized);
      break;
    case MODE_SELECT_SISWA:
      prosesModeSelectSiswa(uid);
      break;
  }
  
  mfrc522.PICC_HaltA();
}

/* ============= BACA UID ============== */
String bacaUID() {
  String uid = "";
  for (byte i = 0; i < mfrc522.uid.size; i++) {
    if (mfrc522.uid.uidByte[i] < 0x10) uid += "0";
    uid += String(mfrc522.uid.uidByte[i], HEX);
    if (i < mfrc522.uid.size - 1) uid += " ";
  }
  uid.toUpperCase();
  return uid;
}

/* ============= MODE NORMAL (ABSENSI) ============== */
void prosesModeNormal(String uidNormalized) {
  // Normalize master UID juga untuk komparasi
  String masterNormalized = masterCardUID;
  masterNormalized.replace(" ", "");
  
  if (uidNormalized == masterNormalized && masterCardTerdaftar) {
    if (siswaAktifIndex >= 0 && siswaAktifIndex < totalSiswa) {
      DataSiswa siswa = daftarSiswa[siswaAktifIndex];
      
      lcd.clear();
      lcd.setCursor(0,0);
      lcd.print("HADIR: " + siswa.nama.substring(0, 9));
      lcd.setCursor(0,1);
      lcd.print("KLS: " + siswa.kelas);
      
      kirimKeWeb(lastScannedUID, siswa.nama, siswa.kelas, "HADIR");
      
      daftarSiswa[siswaAktifIndex].lastAttendance = millis();
      saveDataToEEPROM();
      
      beepSuccess();
      delay(2000);
      updateLCD();
      
    } else {
      lcd.clear();
      lcd.setCursor(0,0);
      lcd.print("BELUM ADA");
      lcd.setCursor(0,1);
      lcd.print("SISWA AKTIF!");
      
      Serial.println("WEB_ALERT: Belum ada siswa aktif!");
      
      beepError();
      delay(2000);
      updateLCD();
    }
  } else {
    lcd.clear();
    lcd.setCursor(0,0);
    lcd.print("KARTU BUKAN");
    lcd.setCursor(0,1);
    lcd.print("MASTER!");
    
    kirimKeWeb(lastScannedUID, "UNKNOWN", "UNKNOWN", "DITOLAK");
    
    beepError();
    delay(2000);
    updateLCD();
  }
}

/* ============= MODE REGISTER SISWA ============== */
void prosesModeRegister(String uid) {
  lcd.clear();
  lcd.setCursor(0,0);
  lcd.print("MODE DAFTAR");
  lcd.setCursor(0,1);
  lcd.print("SISWA BARU");
  
  Serial.println("WEB_INFO: Mode daftar siswa aktif");
  Serial.println("Gunakan serial/web untuk input data");
  
  beep(2);
  delay(1000);
  updateLCD();
}

/* ============= MODE SET MASTER CARD ============== */
void prosesModeSetMaster(String uidNormalized) {
  masterCardUID = lastScannedUID; // Simpan dengan format asli (dengan spasi)
  masterCardTerdaftar = true;
  
  lcd.clear();
  lcd.setCursor(0,0);
  lcd.print("KARTU MASTER");
  lcd.setCursor(0,1);
  lcd.print("TERDAFTAR!");
  
  Serial.print("WEB_MASTER_SET:");
  Serial.println(masterCardUID);
  
  saveMasterCardToEEPROM();
  
  beepSuccess();
  delay(2000);
  
  modeSaatIni = MODE_NORMAL;
  updateLCD();
}

/* ============= MODE SELECT SISWA ============== */
void prosesModeSelectSiswa(String uid) {
  lcd.clear();
  lcd.setCursor(0,0);
  lcd.print("PILIH SISWA");
  lcd.setCursor(0,1);
  lcd.print("AKTIF");
  
  Serial.println("WEB_INFO: Mode pilih siswa aktif");
  Serial.println("Gunakan serial/web untuk pilih");
  
  beep(2);
  delay(1000);
  updateLCD();
}

/* ============= KIRIM DATA KE WEB ============== */
void kirimKeWeb(String uid, String nama, String kelas, String status) {
  Serial.print("WEB,");
  Serial.print(uid);
  Serial.print(",");
  Serial.print(nama);
  Serial.print(",");
  Serial.print(kelas);
  Serial.print(",");
  Serial.println(status);
  
  if (totalLog < 100) {
    logAbsensi[totalLog].uid = uid;
    logAbsensi[totalLog].nama = nama;
    logAbsensi[totalLog].kelas = kelas;
    logAbsensi[totalLog].status = status;
    
    unsigned long seconds = millis() / 1000;
    unsigned long minutes = seconds / 60;
    unsigned long hours = minutes / 60;
    hours = hours % 24;
    minutes = minutes % 60;
    seconds = seconds % 60;
    
    String waktu = String(hours) + ":" + (minutes < 10 ? "0" : "") + String(minutes) + ":" + (seconds < 10 ? "0" : "") + String(seconds);
    logAbsensi[totalLog].waktu = waktu;
    
    totalLog++;
  }
}

/* ============= HANDLE SERIAL COMMAND ============== */
void handleSerialCommand() {
  String cmd = Serial.readStringUntil('\n');
  cmd.trim();
  
  Serial.print("[CMD] ");
  Serial.println(cmd);
  
  String cmdUpper = cmd;
  cmdUpper.toUpperCase();
  
  if (cmdUpper == "HELP") {
    tampilkanMenuHelp();
  }
  else if (cmdUpper == "STATUS") {
    tampilkanStatus();
  }
  else if (cmdUpper == "MODE_NORMAL") {
    modeSaatIni = MODE_NORMAL;
    Serial.println("WEB_OK: Mode Normal");
    updateLCD();
  }
  else if (cmdUpper == "MODE_REGISTER") {
    modeSaatIni = MODE_REGISTER;
    Serial.println("WEB_OK: Mode Register");
    updateLCD();
  }
  else if (cmdUpper == "MODE_SET_MASTER") {
    modeSaatIni = MODE_SET_MASTER;
    lcd.clear();
    lcd.setCursor(0,0);
    lcd.print("SCAN KARTU");
    lcd.setCursor(0,1);
    lcd.print("UNTUK MASTER");
    Serial.println("WEB_OK: Tempelkan kartu untuk Master");
  }
  else if (cmdUpper == "LIST_SISWA") {
    tampilkanDaftarSiswa();
  }
  else if (cmd.startsWith("ADD_SISWA,")) {
    tambahSiswaDariWeb(cmd);
  }
  else if (cmd.startsWith("SET_ACTIVE,")) {
    setSiswaAktif(cmd);
  }
  else if (cmd.startsWith("SET_MASTER,")) {
    setMasterCard(cmd);
  }
  else if (cmdUpper == "GET_MASTER") {
    Serial.print("MASTER_CARD:");
    Serial.println(masterCardUID);
  }
  else if (cmdUpper == "GET_ACTIVE") {
    tampilkanSiswaAktif();
  }
  else if (cmdUpper == "GET_LOG") {
    tampilkanLogAbsensi();
  }
  else if (cmdUpper == "RESET") {
    resetData();
  }
  else if (cmdUpper == "SCAN") {
    lcd.clear();
    lcd.setCursor(0,0);
    lcd.print("SCAN KARTU...");
    Serial.println("WEB_READY: Tempelkan kartu");
  }
  // COMMAND BARU: SET MASTER MANUAL LANGSUNG
  else if (cmdUpper.startsWith("MASTER_SET_MANUAL")) {
    // Format: MASTER_SET_MANUAL,UID
    if (cmd.indexOf(',') != -1) {
      String uidManual = cmd.substring(cmd.indexOf(',') + 1);
      uidManual.trim();
      uidManual.toUpperCase();
      
      masterCardUID = uidManual;
      masterCardTerdaftar = true;
      saveMasterCardToEEPROM();
      
      Serial.print("WEB_OK: Master Manual Diset: ");
      Serial.println(masterCardUID);
      
      lcd.clear();
      lcd.setCursor(0,0);
      lcd.print("MASTER MANUAL:");
      lcd.setCursor(0,1);
      lcd.print(uidManual.substring(0, 16));
      
      beepSuccess();
      delay(2000);
      updateLCD();
    } else {
      Serial.println("WEB_ERROR: Format: MASTER_SET_MANUAL,UID");
    }
  }
  else {
    Serial.println("WEB_ERROR: Command tidak dikenal");
  }
}

/* ============= TAMBAH SISWA DARI WEB ============== */
void tambahSiswaDariWeb(String cmd) {
  int firstComma = cmd.indexOf(',');
  int secondComma = cmd.indexOf(',', firstComma + 1);
  int thirdComma = cmd.indexOf(',', secondComma + 1);
  
  if (firstComma != -1 && secondComma != -1) {
    String nama = cmd.substring(firstComma + 1, secondComma);
    String kelas = cmd.substring(secondComma + 1, thirdComma);
    String nis = (thirdComma != -1) ? cmd.substring(thirdComma + 1) : "-";
    
    if (totalSiswa < 50) {
      daftarSiswa[totalSiswa].nama = nama;
      daftarSiswa[totalSiswa].kelas = kelas;
      daftarSiswa[totalSiswa].nis = nis;
      daftarSiswa[totalSiswa].isActive = false;
      daftarSiswa[totalSiswa].lastAttendance = 0;
      
      totalSiswa++;
      
      if (totalSiswa == 1) {
        siswaAktifIndex = 0;
        daftarSiswa[0].isActive = true;
      }
      
      saveDataToEEPROM();
      
      Serial.print("WEB_OK: Siswa ditambahkan - ");
      Serial.print(nama);
      Serial.print(" (Total: ");
      Serial.print(totalSiswa);
      Serial.println(")");
      
      lcd.clear();
      lcd.setCursor(0,0);
      lcd.print("SISWA DITAMBAH:");
      lcd.setCursor(0,1);
      lcd.print(nama.substring(0, 16));
      
      beepSuccess();
      delay(1500);
      updateLCD();
      
    } else {
      Serial.println("WEB_ERROR: Kapasitas siswa penuh!");
    }
  } else {
    Serial.println("WEB_ERROR: Format salah. Gunakan: ADD_SISWA,nama,kelas,nis");
  }
}

/* ============= SET SISWA AKTIF ============== */
void setSiswaAktif(String cmd) {
  String param = cmd.substring(cmd.indexOf(',') + 1);
  int index = param.toInt() - 1;
  
  if (index >= 0 && index < totalSiswa) {
    for (int i = 0; i < totalSiswa; i++) {
      daftarSiswa[i].isActive = false;
    }
    
    siswaAktifIndex = index;
    daftarSiswa[index].isActive = true;
    
    Serial.print("WEB_OK: Siswa aktif diubah: ");
    Serial.println(daftarSiswa[index].nama);
    
    lcd.clear();
    lcd.setCursor(0,0);
    lcd.print("SISWA AKTIF:");
    lcd.setCursor(0,1);
    lcd.print(daftarSiswa[index].nama.substring(0, 16));
    
    beepSuccess();
    delay(1500);
    updateLCD();
    
  } else {
    for (int i = 0; i < totalSiswa; i++) {
      if (daftarSiswa[i].nama == param) {
        for (int j = 0; j < totalSiswa; j++) {
          daftarSiswa[j].isActive = false;
        }
        
        siswaAktifIndex = i;
        daftarSiswa[i].isActive = true;
        
        Serial.print("WEB_OK: Siswa aktif diubah: ");
        Serial.println(daftarSiswa[i].nama);
        
        beepSuccess();
        return;
      }
    }
    Serial.println("WEB_ERROR: Siswa tidak ditemukan");
  }
}

/* ============= SET MASTER CARD ============== */
void setMasterCard(String cmd) {
  String uid = cmd.substring(cmd.indexOf(',') + 1);
  uid.trim();
  uid.toUpperCase();
  
  masterCardUID = uid;
  masterCardTerdaftar = true;
  
  saveMasterCardToEEPROM();
  
  Serial.print("WEB_OK: Kartu Master diset: ");
  Serial.println(masterCardUID);
  
  lcd.clear();
  lcd.setCursor(0,0);
  lcd.print("KARTU MASTER:");
  lcd.setCursor(0,1);
  lcd.print(uid.substring(0, 16));
  
  beepSuccess();
  delay(1500);
  updateLCD();
}

/* ============= TAMPILKAN STATUS ============== */
void tampilkanStatus() {
  Serial.println("\n=== STATUS SISTEM ===");
  Serial.print("Mode: ");
  switch (modeSaatIni) {
    case MODE_NORMAL: Serial.println("NORMAL"); break;
    case MODE_REGISTER: Serial.println("REGISTER"); break;
    case MODE_SET_MASTER: Serial.println("SET_MASTER"); break;
    case MODE_SELECT_SISWA: Serial.println("SELECT_SISWA"); break;
  }
  
  Serial.print("Kartu Master: ");
  if (masterCardTerdaftar) {
    Serial.println(masterCardUID);
    Serial.print("(Normalized: ");
    String normalized = masterCardUID;
    normalized.replace(" ", "");
    Serial.print(normalized);
    Serial.println(")");
  } else {
    Serial.println("BELUM DISET");
  }
  
  Serial.print("Total Siswa: ");
  Serial.println(totalSiswa);
  
  Serial.print("Siswa Aktif: ");
  if (siswaAktifIndex >= 0) {
    Serial.print(daftarSiswa[siswaAktifIndex].nama);
    Serial.print(" (");
    Serial.print(daftarSiswa[siswaAktifIndex].kelas);
    Serial.println(")");
  } else {
    Serial.println("BELUM DIPILIH");
  }
  
  Serial.print("Total Log Absensi: ");
  Serial.println(totalLog);
  Serial.println("=====================\n");
}

/* ============= TAMPILKAN DAFTAR SISWA ============== */
void tampilkanDaftarSiswa() {
  Serial.println("\n=== DAFTAR SISWA ===");
  if (totalSiswa == 0) {
    Serial.println("Belum ada siswa terdaftar");
  } else {
    for (int i = 0; i < totalSiswa; i++) {
      Serial.print(i + 1);
      Serial.print(". ");
      Serial.print(daftarSiswa[i].nama);
      Serial.print(" | ");
      Serial.print(daftarSiswa[i].kelas);
      Serial.print(" | ");
      Serial.print(daftarSiswa[i].nis);
      if (daftarSiswa[i].isActive) {
        Serial.print(" [AKTIF]");
      }
      Serial.println();
    }
  }
  Serial.println("=====================\n");
}

/* ============= TAMPILKAN SISWA AKTIF ============== */
void tampilkanSiswaAktif() {
  if (siswaAktifIndex >= 0 && siswaAktifIndex < totalSiswa) {
    Serial.print("ACTIVE_STUDENT:");
    Serial.print(daftarSiswa[siswaAktifIndex].nama);
    Serial.print(",");
    Serial.print(daftarSiswa[siswaAktifIndex].kelas);
    Serial.print(",");
    Serial.println(daftarSiswa[siswaAktifIndex].nis);
  } else {
    Serial.println("ACTIVE_STUDENT:NONE");
  }
}

/* ============= TAMPILKAN LOG ABSENSI ============== */
void tampilkanLogAbsensi() {
  Serial.println("\n=== LOG ABSENSI ===");
  if (totalLog == 0) {
    Serial.println("Belum ada absensi");
  } else {
    int startIdx = (totalLog > 10) ? totalLog - 10 : 0;
    for (int i = startIdx; i < totalLog; i++) {
      Serial.print(i + 1);
      Serial.print(". ");
      Serial.print(logAbsensi[i].waktu);
      Serial.print(" | ");
      Serial.print(logAbsensi[i].nama);
      Serial.print(" | ");
      Serial.print(logAbsensi[i].kelas);
      Serial.print(" | ");
      Serial.println(logAbsensi[i].status);
    }
  }
  Serial.println("===================\n");
}

/* ============= TAMPILKAN MENU HELP ============== */
void tampilkanMenuHelp() {
  Serial.println("\n=== MENU PERINTAH ===");
  Serial.println("HELP                - Tampilkan menu ini");
  Serial.println("STATUS              - Status sistem");
  Serial.println("MODE_NORMAL         - Mode absensi normal");
  Serial.println("MODE_REGISTER       - Mode daftar siswa");
  Serial.println("MODE_SET_MASTER     - Mode set kartu master");
  Serial.println("LIST_SISWA          - Daftar semua siswa");
  Serial.println("GET_ACTIVE          - Tampilkan siswa aktif");
  Serial.println("GET_MASTER          - Tampilkan kartu master");
  Serial.println("GET_LOG             - Tampilkan log absensi");
  Serial.println("SCAN                - Minta scan kartu");
  Serial.println("RESET               - Reset semua data");
  Serial.println("MASTER_SET_MANUAL   - Set master manual via serial");
  Serial.println("");
  Serial.println("Format tambah siswa:");
  Serial.println("  ADD_SISWA,nama,kelas,nis");
  Serial.println("");
  Serial.println("Format set siswa aktif:");
  Serial.println("  SET_ACTIVE,index  atau SET_ACTIVE,nama");
  Serial.println("");
  Serial.println("Format set kartu master:");
  Serial.println("  SET_MASTER,UID");
  Serial.println("");
  Serial.println("Format set master manual:");
  Serial.println("  MASTER_SET_MANUAL,UID");
  Serial.println("");
  Serial.println("=====================\n");
}

/* ============= RESET DATA ============== */
void resetData() {
  totalSiswa = 0;
  siswaAktifIndex = -1;
  totalLog = 0;
  masterCardUID = "";
  masterCardTerdaftar = false;
  
  clearEEPROM();
  
  Serial.println("WEB_OK: Semua data direset");
  
  lcd.clear();
  lcd.setCursor(0,0);
  lcd.print("DATA DIHAPUS");
  lcd.setCursor(0,1);
  lcd.print("SISTEM RESET");
  
  beep(3);
  delay(2000);
  updateLCD();
}

/* ============= UPDATE LCD ============== */
void updateLCD() {
  lcd.clear();
  
  if (modeSaatIni == MODE_SET_MASTER) {
    lcd.setCursor(0,0);
    lcd.print("SCAN KARTU");
    lcd.setCursor(0,1);
    lcd.print("UNTUK MASTER");
    return;
  }
  
  lcd.setCursor(0,0);
  if (masterCardTerdaftar) {
    lcd.print("MASTER:READY");
  } else {
    lcd.print("MASTER:NO");
  }
  
  lcd.setCursor(0,1);
  if (siswaAktifIndex >= 0 && siswaAktifIndex < totalSiswa) {
    String nama = daftarSiswa[siswaAktifIndex].nama;
    if (nama.length() > 11) {
      nama = nama.substring(0, 11) + "...";
    }
    lcd.print(nama);
  } else {
    lcd.print("NO ACTIVE STUD");
  }
}

/* ============= BEEP FUNCTIONS ============== */
void beep(int count) {
  for (int i = 0; i < count; i++) {
    digitalWrite(BUZZER_PIN, HIGH);
    delay(100);
    digitalWrite(BUZZER_PIN, LOW);
    if (i < count - 1) delay(100);
  }
}

void beepSuccess() {
  for (int i = 200; i <= 800; i += 100) {
    tone(BUZZER_PIN, i, 50);
    delay(60);
  }
  noTone(BUZZER_PIN);
}

void beepError() {
  for (int i = 800; i >= 200; i -= 100) {
    tone(BUZZER_PIN, i, 50);
    delay(60);
  }
  noTone(BUZZER_PIN);
}

/* ============= EEPROM FUNCTIONS ============== */
void loadDataFromEEPROM() {
  EEPROM.begin(EEPROM_SIZE);
  
  int addr = EEPROM_MASTER_ADDR;
  byte len = EEPROM.read(addr++);
  masterCardUID = "";
  for (int i = 0; i < len; i++) {
    masterCardUID += char(EEPROM.read(addr++));
  }
  masterCardTerdaftar = (len > 0);
  
  addr = EEPROM_DATA_ADDR;
  totalSiswa = EEPROM.read(addr++);
  if (totalSiswa > 50) totalSiswa = 0;
  
  for (int i = 0; i < totalSiswa; i++) {
    byte namaLen = EEPROM.read(addr++);
    daftarSiswa[i].nama = "";
    for (int j = 0; j < namaLen; j++) {
      daftarSiswa[i].nama += char(EEPROM.read(addr++));
    }
    
    byte kelasLen = EEPROM.read(addr++);
    daftarSiswa[i].kelas = "";
    for (int j = 0; j < kelasLen; j++) {
      daftarSiswa[i].kelas += char(EEPROM.read(addr++));
    }
    
    byte nisLen = EEPROM.read(addr++);
    daftarSiswa[i].nis = "";
    for (int j = 0; j < nisLen; j++) {
      daftarSiswa[i].nis += char(EEPROM.read(addr++));
    }
    
    daftarSiswa[i].isActive = EEPROM.read(addr++);
    if (daftarSiswa[i].isActive) {
      siswaAktifIndex = i;
    }
    
    daftarSiswa[i].lastAttendance = 0;
  }
  
  EEPROM.end();
}

void saveDataToEEPROM() {
  EEPROM.begin(EEPROM_SIZE);
  
  int addr = EEPROM_DATA_ADDR;
  EEPROM.write(addr++, totalSiswa);
  
  for (int i = 0; i < totalSiswa; i++) {
    EEPROM.write(addr++, daftarSiswa[i].nama.length());
    for (int j = 0; j < daftarSiswa[i].nama.length(); j++) {
      EEPROM.write(addr++, daftarSiswa[i].nama[j]);
    }
    
    EEPROM.write(addr++, daftarSiswa[i].kelas.length());
    for (int j = 0; j < daftarSiswa[i].kelas.length(); j++) {
      EEPROM.write(addr++, daftarSiswa[i].kelas[j]);
    }
    
    EEPROM.write(addr++, daftarSiswa[i].nis.length());
    for (int j = 0; j < daftarSiswa[i].nis.length(); j++) {
      EEPROM.write(addr++, daftarSiswa[i].nis[j]);
    }
    
    EEPROM.write(addr++, daftarSiswa[i].isActive);
  }
  
  EEPROM.commit();
  EEPROM.end();
}

void saveMasterCardToEEPROM() {
  EEPROM.begin(EEPROM_SIZE);
  
  int addr = EEPROM_MASTER_ADDR;
  EEPROM.write(addr++, masterCardUID.length());
  for (int i = 0; i < masterCardUID.length(); i++) {
    EEPROM.write(addr++, masterCardUID[i]);
  }
  
  EEPROM.commit();
  EEPROM.end();
}

void clearEEPROM() {
  EEPROM.begin(EEPROM_SIZE);
  for (int i = 0; i < EEPROM_SIZE; i++) {
    EEPROM.write(i, 0);
  }
  EEPROM.commit();
  EEPROM.end();
}
